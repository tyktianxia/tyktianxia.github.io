---
title: 模块
date: 2021-12-16 14:13:11
tags: JS
---

# 模块简介

- commonjs
- amd
- esm

amd 基本没有用过，暂且不提。本文暂只介绍 commonjs、esm。

## commonjs
[参考链接](http://javascript.ruanyifeng.com/nodejs/module.html#toc13)

node 模块采用 commonjs 实现，可在 node 中随意使用，但是不兼容浏览器，需要转换工具

### 语法

导入：

```
var a = require("./a.js")
```

导出：  
node 提供一个 Module 构建函数，每个模块都是 Module 的实例  
每个模块内部，都有一个 module 对象，代表当前模块  
且 每个模块内部有一个 exports 对象，指向 module.exports  
可以理解为 在每个模块顶部 var exports = module.exports

- module.id 模块的识别符，通常是带有绝对路径的模块文件名。
- module.filename 模块的文件名，带有绝对路径。
- module.loaded 返回一个布尔值，表示模块是否已经完成加载。
- module.parent 返回一个对象，表示调用该模块的模块。
- module.children 返回一个数组，表示该模块要用到的其他模块。
- module.exports 表示模块对外输出的值。
  以上抄自[这里](http://javascript.ruanyifeng.com/nodejs/module.html#toc1)

导出语句：

```
module.exports = {};
module.exports.a = xxx;
module.exports = c; 可以，虽然module.exports被重新赋值，此时exports变量指向c
如只导出一个单一的值，只能使用module.exports,不能使用exports
```

或者：

```
exports.a = xxx;
exports.b = yyy;
exports 只是指向 module.exports,
故，不能将exports指向另一个对象、变量，无效。
```

目前（node16.12),module.exports 和 exports 好像不能在同一个文件内同时出现（需验证）
建议，只用 module.exports,不用 exports  
2. 关注输出/要输出的变量是 对象还是单一值（string number boolean function 等）

情景：

```
exports.hello = function() {
  return 'hello';
};

module.exports = 'Hello world';
只会输出Hello world,不会输出hello函数
```


### CommonJS规范加载模块是同步的，也就是说，只有加载完成，才能执行后面的操作

### CommonJS有缓存，第一次加载模块之后，node会缓存该模块
可以通过返回一个函数来避免  

所有缓存的模块保存在require.cache之中，如果想删除模块的缓存，可以像下面这样写。

注意，缓存是根据绝对路径识别模块的，


### 循环加载
如果发生模块的循环加载，即A加载B，B又加载A，则B将加载A的不完整版本。
详细[查看文档](http://javascript.ruanyifeng.com/nodejs/module.html#toc1)

### require.main 可以用来判断模块是直接执行，还是被调用执行。
直接执行的时候，require.main属性指向模块本身。


### 加载机制  浅拷贝
对于基本数据类型，属于复制。
对于复杂数据类型，属于浅拷贝。



## CommonJS与ES6模块化规范区别
CommonJS:  
+ 加载机制：复制/浅拷贝，可读，缓存
+ 书写位置：代码里的任意位置
+ 同步
+ 运行时加载

ESM:  
+ 加载机制：动态只读引用，（原始类型值变化时也会导致import的变量发生变化）
+ 首行，不能加杂在其余代码之间
+ 异步？？？
+ 编译时加载


## 深拷贝&浅拷贝
+ 深拷贝： o2和o1没有任何引用关系，只是值相同
+ 浅拷贝： 不是深拷贝就是浅拷贝（即o2还有对o1的引用，那就是浅拷贝），
+ 注意：嵌套对象，需小心考虑

### 深浅拷贝方式
+ 深拷贝：
    - JSON.parse(JSON.stringfy(x)),不能处理函数、正则、sysbom等
    - 自定义深拷贝处理函数
    - loadsh 三方库
+ 浅拷贝
    - assign
    - 对象赋值
    - concat
    - 等等等
